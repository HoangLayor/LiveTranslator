<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Live Translator</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f1f1f1;
      }

      h2 {
        text-align: center;
        margin-bottom: 20px;
      }

      .select-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      #messageList {
        border-radius: 10px;
        height: 60vh;
        overflow-y: auto;
        background-color: #fff;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }

      .message {
        display: flex;
        margin-bottom: 12px;
      }

      .user {
        justify-content: flex-end;
      }

      .ai {
        justify-content: flex-start;
      }

      .bubble {
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 70%;
        position: relative;
        font-size: 15px;
        line-height: 1.5;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .user .bubble {
        background-color: #daf5e9;
        color: #000;
        border-bottom-right-radius: 4px;
      }

      .ai .bubble {
        background-color: #eeeeee;
        color: #000;
        border-bottom-left-radius: 4px;
      }

      .play-button {
        margin-top: 5px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
      }

      #controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }

      #textInput {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      button,
      select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
      }

      #recordingStatus,
      #connectionStatus {
        margin-top: 5px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <h2>ğŸŒ Live Translator</h2>
    <div id="connectionStatus">Äang káº¿t ná»‘i...</div>
    <div class="select-group">
      <div>
        ğŸ—£ï¸ Ghi Ã¢m báº±ng:
        <select id="sourceLang">
          <option value="vi-VN">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
          <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
          <option value="fr-FR">ğŸ‡«ğŸ‡· Tiáº¿ng PhÃ¡p</option>
          <option value="ru-RU">ğŸ‡·ğŸ‡º Tiáº¿ng Nga</option>
        </select>
      </div>
      <div>
        ğŸŒ Dá»‹ch sang:
        <select id="lang">
          <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
          <option value="en">ğŸ‡¬ğŸ‡§ English</option>
          <option value="fr">ğŸ‡«ğŸ‡· Tiáº¿ng PhÃ¡p</option>
          <option value="ru">ğŸ‡·ğŸ‡º Tiáº¿ng Nga</option>
        </select>
      </div>
    </div>

    <div id="messageList"></div>

    <div id="controls">
      <input id="textInput" placeholder="Nháº­p hoáº·c nÃ³i Ä‘iá»u gÃ¬ Ä‘Ã³..." />
      <button onclick="handleTranslate()">Dá»‹ch</button>
      <button id="recordButton">ğŸ™ï¸ Ghi Ã¢m</button>
      <button id="stopButton" disabled>ğŸ›‘ Dá»«ng</button>
      <button onclick="clearMessages()">XÃ³a táº¥t cáº£</button>
    </div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition;
      let socket;
      let targetLanguage = "vi";
      let recordingTimeout; // Bá»™ Ä‘áº¿m thá»i gian dá»«ng ghi Ã¢m sau X giÃ¢y
      const MAX_RECORDING_TIME_MS = 30000; // Ghi Ã¢m tá»‘i Ä‘a 10 giÃ¢y
      function clearMessages() {
        const messageList = document.getElementById("messageList");
        messageList.innerHTML = "";
      }

      // Kiá»ƒm tra trÃ¬nh duyá»‡t há»— trá»£ SpeechRecognition
      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; // Ghi Ã¢m 1 cÃ¢u rá»“i dá»«ng
        recognition.interimResults = false;

        recognition.onstart = () => updateRecordingStatus(true);
        recognition.onend = () => updateRecordingStatus(false);
        recognition.onerror = (e) => console.error("STT error:", e);

        // Khi cÃ³ káº¿t quáº£ ghi Ã¢m
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById("textInput").value = transcript;
          handleTranslate();
        };
      }

      // Káº¿t ná»‘i WebSocket tá»›i backend
      function initWebSocket() {
        socket = new WebSocket("ws://localhost:8000/ws");

        socket.onopen = () => updateConnectionStatus("ÄÃ£ káº¿t ná»‘i", "green");
        socket.onclose = () => {
          updateConnectionStatus("Máº¥t káº¿t ná»‘i", "red");
          setTimeout(initWebSocket, 3000); // Tá»± Ä‘á»™ng reconnect
        };
        socket.onerror = () => updateConnectionStatus("Lá»—i káº¿t ná»‘i", "red");

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === "translation") {
            appendMessage("ai", data.text);
          } else if (data.type === "audio") {
            const audioBase64 = data.audio;
            if (audioBase64) {
              const audioBlob = new Blob(
                [
                  new Uint8Array(
                    atob(audioBase64)
                      .split("")
                      .map((c) => c.charCodeAt(0))
                  ),
                ],
                { type: "audio/wav" }
              );
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.play();
            }
          } else if (data.type === "error") {
            appendMessage("ai", "[Lá»—i] " + data.message);
          }
        };
      }

      // Cáº­p nháº­t tráº¡ng thÃ¡i káº¿t ná»‘i WebSocket
      function updateConnectionStatus(text, color) {
        const el = document.getElementById("connectionStatus");
        el.textContent = text;
        el.style.color = color;
      }

      // Hiá»ƒn thá»‹ tin nháº¯n
      function appendMessage(sender, text) {
        const messageList = document.getElementById("messageList");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message " + sender;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        if (sender === "ai") {
          const playBtn = document.createElement("button");
          playBtn.className = "play-button";
          playBtn.textContent = "ğŸ”Š";
          playBtn.onclick = () => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(
                JSON.stringify({
                  type: "playText",
                  text,
                  target_lang: targetLanguage,
                })
              );
            }
          };
          bubble.appendChild(document.createElement("br"));
          bubble.appendChild(playBtn);
        }

        messageDiv.appendChild(bubble);
        messageList.appendChild(messageDiv);
        messageList.scrollTop = messageList.scrollHeight;
      }

      // Gá»­i ná»™i dung Ä‘á»ƒ dá»‹ch
      function handleTranslate() {
        const input = document.getElementById("textInput");
        const text = input.value.trim();
        if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;

        appendMessage("user", text);

        socket.send(
          JSON.stringify({
            type: "translate",
            text,
            target_lang: targetLanguage,
          })
        );

        input.value = "";
      }

      // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i ghi Ã¢m
      function updateRecordingStatus(isRecording) {
        const status = document.getElementById("recordingStatus");
        document.getElementById("recordButton").disabled = isRecording;
        document.getElementById("stopButton").disabled = !isRecording;
        status.textContent = isRecording ? "Äang ghi Ã¢m..." : "Sáºµn sÃ ng";
        status.style.color = isRecording ? "green" : "black";
      }

      // Cáº­p nháº­t ngÃ´n ngá»¯ Ä‘Ã­ch Ä‘á»ƒ dá»‹ch
      document.getElementById("lang").addEventListener("change", (e) => {
        targetLanguage = e.target.value;
      });

      // Báº¯t Ä‘áº§u ghi Ã¢m (vÃ  háº¹n giá» tá»± Ä‘á»™ng dá»«ng sau 10 giÃ¢y)
      window.startRecording = function () {
        const sourceLang = document.getElementById("sourceLang").value;
        if (recognition) {
          recognition.lang = sourceLang;
          recognition.start();

          // Háº¹n giá» dá»«ng ghi Ã¢m sau X giÃ¢y
          recordingTimeout = setTimeout(() => {
            recognition.stop();
          }, MAX_RECORDING_TIME_MS);
        }
      };

      // Dá»«ng ghi Ã¢m thá»§ cÃ´ng (vÃ  há»§y timeout)
      window.stopRecording = function () {
        if (recognition) {
          recognition.stop();
          clearTimeout(recordingTimeout);
        }
      };

      // Khi DOM Ä‘Ã£ sáºµn sÃ ng
      document.addEventListener("DOMContentLoaded", () => {
        initWebSocket();
        document
          .getElementById("recordButton")
          .addEventListener("click", startRecording);
        document
          .getElementById("stopButton")
          .addEventListener("click", stopRecording);
      });
    </script>
  </body>
</html>
