<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Live Translator</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f1f1f1;
      }

      h2 {
        text-align: center;
        margin-bottom: 20px;
      }

      .select-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
      }

      #messageList {
        border-radius: 10px;
        height: 60vh;
        overflow-y: auto;
        background-color: #fff;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
      }

      .message {
        display: flex;
        margin-bottom: 12px;
      }

      .user {
        justify-content: flex-end;
      }

      .ai {
        justify-content: flex-start;
      }

      .bubble {
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 70%;
        position: relative;
        font-size: 15px;
        line-height: 1.5;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .user .bubble {
        background-color: #daf5e9;
        color: #000;
        border-bottom-right-radius: 4px;
      }

      .ai .bubble {
        background-color: #eeeeee;
        color: #000;
        border-bottom-left-radius: 4px;
      }

      .play-button {
        margin-top: 5px;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
      }

      #controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }

      #textInput {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
      }

      button,
      select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
      }

      #recordingStatus,
      #connectionStatus {
        margin-top: 5px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <h2>🌐 Live Translator</h2>
    <div id="connectionStatus">Đang kết nối...</div>
    <div class="select-group">
      <div>
        🗣️ Ghi âm bằng:
        <select id="sourceLang">
          <option value="vi-VN">🇻🇳 Tiếng Việt</option>
          <option value="en-US">🇺🇸 English</option>
          <option value="fr-FR">🇫🇷 Tiếng Pháp</option>
          <option value="ru-RU">🇷🇺 Tiếng Nga</option>
        </select>
      </div>
      <div>
        🌐 Dịch sang:
        <select id="lang">
          <option value="vi">🇻🇳 Tiếng Việt</option>
          <option value="en">🇬🇧 English</option>
          <option value="fr">🇫🇷 Tiếng Pháp</option>
          <option value="ru">🇷🇺 Tiếng Nga</option>
        </select>
      </div>
    </div>

    <div id="messageList"></div>

    <div id="controls">
      <input id="textInput" placeholder="Nhập hoặc nói điều gì đó..." />
      <button onclick="handleTranslate()">Dịch</button>
      <button id="recordButton">🎙️ Ghi âm</button>
      <button id="stopButton" disabled>🛑 Dừng</button>
      <button onclick="clearMessages()">Xóa tất cả</button>
    </div>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition;
      let socket;
      let targetLanguage = "vi";
      let recordingTimeout; // Bộ đếm thời gian dừng ghi âm sau X giây
      const MAX_RECORDING_TIME_MS = 30000; // Ghi âm tối đa 10 giây
      function clearMessages() {
        const messageList = document.getElementById("messageList");
        messageList.innerHTML = "";
      }

      // Kiểm tra trình duyệt hỗ trợ SpeechRecognition
      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; // Ghi âm 1 câu rồi dừng
        recognition.interimResults = false;

        recognition.onstart = () => updateRecordingStatus(true);
        recognition.onend = () => updateRecordingStatus(false);
        recognition.onerror = (e) => console.error("STT error:", e);

        // Khi có kết quả ghi âm
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById("textInput").value = transcript;
          handleTranslate();
        };
      }

      // Kết nối WebSocket tới backend
      function initWebSocket() {
        socket = new WebSocket("ws://localhost:8000/ws");

        socket.onopen = () => updateConnectionStatus("Đã kết nối", "green");
        socket.onclose = () => {
          updateConnectionStatus("Mất kết nối", "red");
          setTimeout(initWebSocket, 3000); // Tự động reconnect
        };
        socket.onerror = () => updateConnectionStatus("Lỗi kết nối", "red");

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === "translation") {
            appendMessage("ai", data.text);
          } else if (data.type === "audio") {
            const audioBase64 = data.audio;
            if (audioBase64) {
              const audioBlob = new Blob(
                [
                  new Uint8Array(
                    atob(audioBase64)
                      .split("")
                      .map((c) => c.charCodeAt(0))
                  ),
                ],
                { type: "audio/wav" }
              );
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.play();
            }
          } else if (data.type === "error") {
            appendMessage("ai", "[Lỗi] " + data.message);
          }
        };
      }

      // Cập nhật trạng thái kết nối WebSocket
      function updateConnectionStatus(text, color) {
        const el = document.getElementById("connectionStatus");
        el.textContent = text;
        el.style.color = color;
      }

      // Hiển thị tin nhắn
      function appendMessage(sender, text) {
        const messageList = document.getElementById("messageList");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message " + sender;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        if (sender === "ai") {
          const playBtn = document.createElement("button");
          playBtn.className = "play-button";
          playBtn.textContent = "🔊";
          playBtn.onclick = () => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(
                JSON.stringify({
                  type: "playText",
                  text,
                  target_lang: targetLanguage,
                })
              );
            }
          };
          bubble.appendChild(document.createElement("br"));
          bubble.appendChild(playBtn);
        }

        messageDiv.appendChild(bubble);
        messageList.appendChild(messageDiv);
        messageList.scrollTop = messageList.scrollHeight;
      }

      // Gửi nội dung để dịch
      function handleTranslate() {
        const input = document.getElementById("textInput");
        const text = input.value.trim();
        if (!text || !socket || socket.readyState !== WebSocket.OPEN) return;

        appendMessage("user", text);

        socket.send(
          JSON.stringify({
            type: "translate",
            text,
            target_lang: targetLanguage,
          })
        );

        input.value = "";
      }

      // Hiển thị trạng thái ghi âm
      function updateRecordingStatus(isRecording) {
        const status = document.getElementById("recordingStatus");
        document.getElementById("recordButton").disabled = isRecording;
        document.getElementById("stopButton").disabled = !isRecording;
        status.textContent = isRecording ? "Đang ghi âm..." : "Sẵn sàng";
        status.style.color = isRecording ? "green" : "black";
      }

      // Cập nhật ngôn ngữ đích để dịch
      document.getElementById("lang").addEventListener("change", (e) => {
        targetLanguage = e.target.value;
      });

      // Bắt đầu ghi âm (và hẹn giờ tự động dừng sau 10 giây)
      window.startRecording = function () {
        const sourceLang = document.getElementById("sourceLang").value;
        if (recognition) {
          recognition.lang = sourceLang;
          recognition.start();

          // Hẹn giờ dừng ghi âm sau X giây
          recordingTimeout = setTimeout(() => {
            recognition.stop();
          }, MAX_RECORDING_TIME_MS);
        }
      };

      // Dừng ghi âm thủ công (và hủy timeout)
      window.stopRecording = function () {
        if (recognition) {
          recognition.stop();
          clearTimeout(recordingTimeout);
        }
      };

      // Khi DOM đã sẵn sàng
      document.addEventListener("DOMContentLoaded", () => {
        initWebSocket();
        document
          .getElementById("recordButton")
          .addEventListener("click", startRecording);
        document
          .getElementById("stopButton")
          .addEventListener("click", stopRecording);
      });
    </script>
  </body>
</html>
