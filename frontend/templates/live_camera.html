<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera D·ªãch ·∫¢nh</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    button {
      padding: 10px 16px;
      margin: 5px 0;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #4caf50;
      color: white;
    }
    button:hover {
      background-color: #45a049;
    }
    video, img {
      display: block;
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    #result {
      margin-top: 15px;
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>üì∑ D·ªãch ·∫£nh qua camera</h2>

  <button id="startCameraBtn">B·∫≠t camera</button>

  <div id="cameraSection" style="display: none;">
    <video id="cameraPreview" autoplay playsinline width="320" height="240"></video>
    <button onclick="takePhoto()">üì∏ Ch·ª•p ·∫£nh & G·ª≠i</button>
  </div>

  <img id="photo" alt="·∫¢nh ƒë√£ ch·ª•p s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y" />

  <div id="result">K·∫øt qu·∫£ d·ªãch s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>

  <script>
    const startCameraBtn = document.getElementById("startCameraBtn");
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("cameraPreview");
    const photo = document.getElementById("photo");
    const resultDiv = document.getElementById("result");

    let socket;

    // K·∫øt n·ªëi WebSocket
    function connectWebSocket() {
      socket = new WebSocket("ws://localhost:8000/ws"); // ‚úÖ C·∫≠p nh·∫≠t URL n·∫øu kh√°c

      socket.onopen = () => console.log("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket");
      socket.onerror = (e) => console.error("‚ùå WS l·ªói:", e);
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === "translation") {
            resultDiv.textContent = "‚úÖ D·ªãch: " + data.text;
          }
        } catch (err) {
          console.error("L·ªói x·ª≠ l√Ω k·∫øt qu·∫£:", err);
        }
      };
    }

    connectWebSocket();

    // B·∫≠t camera
    startCameraBtn.addEventListener("click", () => {
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
          cameraSection.style.display = "block";
          startCameraBtn.disabled = true;
        })
        .catch((err) => {
          alert("Kh√¥ng th·ªÉ truy c·∫≠p camera. Ki·ªÉm tra HTTPS & quy·ªÅn.");
          console.error("Camera error:", err);
        });
    });

    // Ch·ª•p ·∫£nh v√† g·ª≠i qua WS
    function takePhoto() {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const base64Image = canvas.toDataURL("image/png");

      photo.src = base64Image;

      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(
          JSON.stringify({
            type: "image",
            image: base64Image,
          })
        );
        resultDiv.textContent = "‚è≥ ƒêang d·ªãch ·∫£nh...";
      } else {
        resultDiv.textContent = "‚ùå WebSocket ch∆∞a k·∫øt n·ªëi.";
      }
    }
  </script>
</body>
</html>
